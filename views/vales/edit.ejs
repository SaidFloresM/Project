<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Vale - Sistema de Vales</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <%- include('../partials/navbar') %>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Editar Vale</h1>
                <a href="/vales" class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-arrow-left mr-2"></i>Volver a la lista
                </a>
            </div>

            <form action="/vales/<%= vale._id %>" method="POST" enctype="multipart/form-data" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                <!-- Información básica -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-info-circle mr-2"></i>Información Básica
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="folio">
                                Número de Vale
                            </label>
                            <input type="text" id="folio" name="folio" value="<%= vale.folio %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="fechaViaje">
                                Fecha del Viaje
                            </label>
                            <input type="date" id="fechaViaje" name="fechaViaje" 
                                value="<%= new Date(vale.fechaViaje).toISOString().split('T')[0] %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                </div>

                <!-- Cliente y Unidad -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-building mr-2"></i>Cliente y Unidad
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="cliente">
                                Cliente
                            </label>
                            <input type="text" id="cliente" name="cliente" value="<%= vale.cliente %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="unidad">
                                Unidad
                            </label>
                            <input type="text" id="unidad" name="unidad" value="<%= vale.unidad %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                </div>

                <!-- Origen y Destino -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-map-marked-alt mr-2"></i>Ruta
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="origen">
                                Origen
                            </label>
                            <input type="text" id="origen" name="origen" value="<%= vale.origen %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="destino">
                                Destino
                            </label>
                            <input type="text" id="destino" name="destino" value="<%= vale.destino %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                </div>

                <!-- Custodios -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-users mr-2"></i>Custodios
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="custodio1">
                                Custodio 1
                            </label>
                            <input type="text" id="custodio1" name="custodio1" value="<%= vale.custodio1 %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline custodio-input"
                                list="custodiosList">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="custodio2">
                                Custodio 2
                            </label>
                            <input type="text" id="custodio2" name="custodio2" value="<%= vale.custodio2 %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline custodio-input"
                                list="custodiosList">
                        </div>
                    </div>
                    <datalist id="custodiosList"></datalist>
                </div>

                <!-- Estatus -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-check-circle mr-2"></i>Estatus
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="estatus">
                                Estado del Vale
                            </label>
                            <select id="estatus" name="estatus" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Capturado" <%= vale.estatus === 'Capturado' ? 'selected' : '' %>>Capturado</option>
                                <option value="Verificado" <%= vale.estatus === 'Verificado' ? 'selected' : '' %>>Verificado</option>
                                <option value="Cancelado" <%= vale.estatus === 'Cancelado' ? 'selected' : '' %>>Cancelado</option>
                            </select>
                        </div>
                        <div id="verificacionFields" style="display: <%= vale.estatus === 'Verificado' ? 'block' : 'none' %>;">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2" for="fechaVerificado">
                                        Fecha Verificación
                                    </label>
                                    <input type="date" id="fechaVerificado" name="fechaVerificado" 
                                        value="<%= vale.fechaVerificado ? new Date(vale.fechaVerificado).toISOString().split('T')[0] : '' %>"
                                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2" for="horaVerificado">
                                        Hora Verificación
                                    </label>
                                    <input type="time" id="horaVerificado" name="horaVerificado" 
                                        value="<%= vale.horaVerificado || '' %>"
                                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información Financiera -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-money-bill-wave mr-2"></i>Información Financiera
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="viaticosDepositados">
                                Viáticos Depositados
                            </label>
                            <input type="number" step="0.01" id="viaticosDepositados" name="viaticosDepositados" 
                                value="<%= vale.viaticosDepositados %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="montoEfectivo">
                                Monto en Efectivo
                            </label>
                            <input type="number" step="0.01" id="montoEfectivo" name="montoEfectivo" 
                                value="<%= vale.montoEfectivo %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="efectivoEntregadoVia">
                                Efectivo Entregado Vía
                            </label>
                            <input type="text" id="efectivoEntregadoVia" name="efectivoEntregadoVia" 
                                value="<%= vale.efectivoEntregadoVia %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="montoViaje">
                                Monto del Viaje
                            </label>
                            <input type="number" step="0.01" id="montoViaje" name="montoViaje" 
                                value="<%= vale.montoViaje %>" required 
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                </div>

                <!-- Gastos -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-receipt mr-2"></i>Gastos
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="casetas">
                                Casetas
                            </label>
                            <input type="number" step="0.01" id="casetas" name="casetas" 
                                value="<%= vale.casetas %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="peajes">
                                Peajes
                            </label>
                            <input type="number" step="0.01" id="peajes" name="peajes" 
                                value="<%= vale.peajes %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="gasolinaFacturada">
                                Gasolina Facturada
                            </label>
                            <input type="number" step="0.01" id="gasolinaFacturada" name="gasolinaFacturada" 
                                value="<%= vale.gasolinaFacturada %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="hospedaje">
                                Hospedaje
                            </label>
                            <input type="number" step="0.01" id="hospedaje" name="hospedaje" 
                                value="<%= vale.hospedaje %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="otros">
                                Otros Gastos
                            </label>
                            <input type="number" step="0.01" id="otros" name="otros" 
                                value="<%= vale.otros %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="cargosAdicionales">
                                Cargos Adicionales
                            </label>
                            <input type="number" step="0.01" id="cargosAdicionales" name="cargosAdicionales" 
                                value="<%= vale.cargosAdicionales %>"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                </div>

                <!-- Referencia del Cliente -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-tag mr-2"></i>Referencia del Cliente
                    </h2>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="referenciaCliente">
                            Referencia
                        </label>
                        <input type="text" id="referenciaCliente" name="referenciaCliente" 
                            value="<%= vale.referenciaCliente %>"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                </div>

                <!-- Notas y Archivos -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <i class="fas fa-file-alt mr-2"></i>Notas y Archivos
                    </h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="notas">
                            Notas
                        </label>
                        <textarea id="notas" name="notas" 
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32"><%= vale.notas %></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Imágenes Actuales
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                            <% vale.imagenes.forEach(imagen => { %>
                                <div class="relative">
                                    <img src="/uploads/<%= imagen %>" alt="Imagen del vale" class="w-full h-32 object-cover rounded">
                                </div>
                            <% }) %>
                        </div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="imagenes">
                            Agregar Nuevas Imágenes
                        </label>
                        <input type="file" id="imagenes" name="imagenes" multiple accept="image/*"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                </div>

                <div class="flex items-center justify-end">
                    <button type="submit" 
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center">
                        <i class="fas fa-save mr-2"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        // Autocompletado de custodios
        document.querySelectorAll('.custodio-input').forEach(input => {
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                if (query.length < 2) return;

                try {
                    const response = await fetch(`/custodios/buscar?query=${encodeURIComponent(query)}`);
                    const custodios = await response.json();
                    
                    const datalist = document.getElementById('custodiosList');
                    datalist.innerHTML = '';
                    
                    custodios.forEach(custodio => {
                        const option = document.createElement('option');
                        option.value = custodio.nombre;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error al buscar custodios:', error);
                }
            });
        });

        // Mostrar/ocultar campos de verificación
        document.getElementById('estatus').addEventListener('change', function() {
            const verificacionFields = document.getElementById('verificacionFields');
            verificacionFields.style.display = this.value === 'Verificado' ? 'block' : 'none';
        });

        // Calcular totales automáticamente
        const calcularTotales = () => {
            const gastos = ['casetas', 'peajes', 'gasolinaFacturada', 'hospedaje', 'otros', 'cargosAdicionales'];
            let total = 0;
            
            gastos.forEach(gasto => {
                const valor = parseFloat(document.getElementById(gasto).value) || 0;
                total += valor;
            });

            const viaticos = parseFloat(document.getElementById('viaticosDepositados').value) || 0;
            const saldoPendiente = viaticos - total;

            // Aquí podrías mostrar los totales en tiempo real si lo deseas
        };

        // Agregar event listeners a todos los campos numéricos
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', calcularTotales);
        });
    </script>
</body>
</html>